#!/bin/bash
set -e
echo "卸载前执行的脚本 - prerm -> $1"


check_some_run() {
    # Check if any Burp Suite processes are running
    if pgrep -f "python\s+-m\s+http.server.*" >/dev/null; then
        echo "python server is running"
        echo "-------------------------------"
        ps -aux | grep -E ".*python\s+-m\s+http.server.*" | grep -v grep
        echo "-------------------------------"
        
        read -p "Stop these processes? (y/N): " -n 1
        echo ""
        
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            echo "Stopping processes..."
            
            # Attempt graceful termination
            pkill -f "python\s+-m\s+http.server.*" 2>/dev/null || true
            sleep 2
            
            # Check if any processes remain
            if pgrep -f "python\s+-m\s+http.server.*" >/dev/null; then
                echo "Some processes still running, attempting forceful termination..."
                pkill -9 -f "python\s+-m\s+http.server.*" 2>/dev/null || true
                sleep 1
            fi
            
            # Final check
            if pgrep -f "python\s+-m\s+http.server.*" >/dev/null; then
                echo "Unable to stop all processes. Please manually close Burp Suite."
                exit 1
            else
                echo "All processes terminated successfully."
            fi
        else
            echo "Please close Burp Suite manually before continuing."
            exit 1
        fi
    fi
}

case "$1" in 
    remove | purge | upgrade)
    check_some_run
    ;;
esac